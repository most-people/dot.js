<!DOCTYPE html>
<html>
    <head>
        <title>api.most.box</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <link rel="stylesheet" href="/index.css" />
    </head>
    <body>
        <div id="app">
            <h2>☭ 为人民服务</h2>
            <h1 id="hello">IPFS + Filecoin + Fastify + Dot.js + Smart Contracts = Fully DApp</h1>

            <div>
                <textarea id="inputMnemonic" placeholder="请输入助记词"></textarea>
            </div>

            <div>
                <button id="btnInitialize">初始化钱包</button>
                <span id="addressDisplay"></span>
            </div>

            <div>
                <input type="text" id="inputName" placeholder="输入名称" />
                <button id="btnSave" disabled>保存</button>
            </div>
        </div>

        <script src="/dotClient.js"></script>
        <script type="module">
            import { ethers } from 'https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js'

            const dotClient = new DotClient('http://localhost:1977')
            let userAddress = ''

            // 初始化钱包
            btnInitialize.addEventListener('click', async () => {
                try {
                    const mnemonic = inputMnemonic.value.trim()
                    if (!mnemonic) {
                        alert('请输入助记词')
                        return
                    }

                    // 初始化钱包
                    const wallet = ethers.HDNodeWallet.fromPhrase(mnemonic)
                    // 设置签名器
                    dotClient.setSigner(wallet)

                    userAddress = wallet.address
                    addressDisplay.textContent = `当前地址: ${userAddress}`

                    // 创建用户实例
                    const dot = dotClient.dot(userAddress)

                    // 读取用户数据
                    dot.once('profile', (profile) => {
                        console.log('用户配置:', profile)
                        if (profile && profile.name) {
                            inputName.value = profile.name
                        }
                    })

                    // 监听用户数据变化
                    dot.on('profile', (profile) => {
                        if (profile && profile.name) {
                            inputName.value = profile.name
                        }
                        console.log('用户数据更新:', profile)
                    })

                    // 启用保存按钮
                    btnSave.disabled = false
                } catch (err) {
                    console.error('初始化钱包失败:', err)
                    alert('初始化钱包失败: ' + err.message)
                }
            })

            btnSave.addEventListener('click', async () => {
                if (!userAddress) {
                    alert('请先初始化钱包')
                    return
                }

                try {
                    const dot = dotClient.dot(userAddress)
                    // 存储用户数据
                    await dot.put('profile', {
                        name: inputName.value,
                        bio: 'Web3 Developer',
                    })
                } catch (err) {
                    console.error('保存失败:', err)
                    alert('保存失败: ' + err.message)
                }
            })
        </script>
    </body>
</html>
